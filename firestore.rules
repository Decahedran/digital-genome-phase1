rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthed() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthed() && request.auth.uid == userId;
    }

    // USERS: user can read/write their own user doc
    match /users/{userId} {
      allow read, create, update, delete: if isOwner(userId);
    }

    // PROFILES: owner-only access
    match /profiles/{profileId} {
      // Create: validate userId being written matches auth.uid
      allow create: if isAuthed() && request.resource.data.userId == request.auth.uid;

      // Read/Delete: validate existing doc belongs to auth.uid
      allow read, delete: if isAuthed() && resource.data.userId == request.auth.uid;

      // Update: existing owner only, and userId cannot be reassigned
      allow update: if isAuthed()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;
    }

    // TRAITS: doc id = profileId; owner-only access
    match /traits/{profileId} {
      // Create: validate userId being written matches auth.uid
      allow create: if isAuthed() && request.resource.data.userId == request.auth.uid;

      // Read/Delete: validate existing doc belongs to auth.uid
      allow read, delete: if isAuthed() && resource.data.userId == request.auth.uid;

      // Update: existing owner only, and userId cannot be reassigned
      allow update: if isAuthed()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;
    }

    // ASSESSMENTS: owner-only historical records
    match /assessments/{assessmentId} {
      // Create: record must belong to authenticated user
      allow create: if isAuthed() && request.resource.data.userId == request.auth.uid;

      // Read/Delete: owner only
      allow read, delete: if isAuthed() && resource.data.userId == request.auth.uid;

      // Update: owner only, and userId cannot be reassigned
      allow update: if isAuthed()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;
    }
  }
}
